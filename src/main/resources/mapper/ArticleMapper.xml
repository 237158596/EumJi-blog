<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.eumji.zblog.mapper.ArticleMapper">
    <cache eviction="LRU" flushInterval="60000" readOnly="true"/>
    <resultMap id="article" type="com.eumji.zblog.vo.ArticleCustom">
        <id column="id" property="id"></id>
        <result column="categoryId" property="categoryId"/>
        <result column="title" property="title"/>
        <result column="content" property="content"/>
        <result column="status" property="status"/>
        <result column="author" property="author"/>
        <result column="createTime" property="createTime"/>
        <result column="showCount" property="showCount"/>
        <collection property="tagList" column="id" select="getTag"/>

    </resultMap>

    <!--获取所有的文章-->
   <select id="getArticleCount" resultType="int">
       select count(id) from article where status = 1
   </select>
    <!--分页获取文章-->
    <select id="getArticleList" resultMap="article">

        select article.id,categoryId,categoryName,aliasName,title,content,description,status,author,createTime,updateTime,showCount from article,category where status=1 and article.categoryId = category.id limit #{start},#{limit}
    </select>

    <select id="getTag" resultType="articleTag">
        select * from articletag where articleId = #{id}
    </select>

    <select id="loadArticleByCategory" resultMap="article">
         select article.id,categoryId,categoryName,aliasName,title,content,description,status,author,createTime,updateTime,showCount from article,category where status=1 and categoryId=#{categoryId} and article.categoryId = category.id limit #{pager.start},#{pager.limit}
    </select>


    <select id="loadArticleByTag" resultMap="article">
       select article.id,categoryId,categoryName,aliasName,title,content,description,status,author,createTime,updateTime,showCount from article,category where status=1 and article.id in (select DISTINCT articleId from articletag where tagId = #{tagId} ) limit #{pager.start},#{pager.limit}

    </select>

    <select id="initPage" resultType="int">
      select count(id) from article
    </select>
    
    <select id="loadArticle" resultType="article" parameterType="map">
        select article.id,title,categoryId,categoryName,status,createTime from article join category on article.categoryId=category.id where 1=1
        <if test="categoryId != null and categoryId != ''">
            and categoryId = #{categoryId}
        </if>
        <if test="tags != null and tags.length>0">
            and article.id in (select DISTINCT articleId from articletag where articletag.id in
            <foreach collection="tags" item="item" index="index" open="(" separator="," close=")">
                #{item}
            </foreach>
            )
        </if>
        <if test="title != null and title != ''">
            and title like concat('%',#{title},'%')
        </if>
        order by createTime desc limit #{pager.start},#{pager.limit}
    </select>

    <update id="updateStatue">
        update article set status = #{status} where id = #{id}
    </update>


    <insert id="saveArticle">
        insert into article(id,categoryId, title, content, description, createTime) values(#{id},#{categoryId},#{title},#{content},#{description},#{createTime})
    </insert>
    
    <insert id="saveArticleTag">
        INSERT into articletag(articleId, tagId, tagName)
        <foreach collection="tags" item="item" index="index" separator=" union all">
            SELECT #{articleId},#{item},(select tagName from tag where id =#{item})
        </foreach>
    </insert>

    <select id="checkExist" resultType="int">
        select count(id) from article where id = #{id}
    </select>

    <select id="getArticleById" resultType="article">
        select id,title,description,content,categoryId from article where id = #{id}
    </select>
    
    <update id="updateArticle">
        update article set title = #{title},description = #{description},content = #{content},updateTime = #{updateTime},categoryId = #{categoryId} where id = #{id}
    </update>
    
    <delete id="deleteArticleTag">
        delete from articletag where articleId = #{articleId}
    </delete>

    <delete id="deleteArticle">
        delete from article where id = #{id}
    </delete>
    <!--通过id查找 博文的详细信息-->
    <select id="getArticleCustomById" resultMap="article">
        select article.id,categoryId,categoryName,aliasName,title,content,description,status,author,createTime,updateTime,showCount from article,category where status=1 and article.categoryId = category.id and article.id = #{id}
    </select>

    <select id="getLastArticle" resultType="article">
        select id,title from article where createTime &lt; (select createTime from article where id = #{id}) ORDER BY createTime desc LIMIT 1
    </select>

    <select id="getNextArticle" resultType="article">
        select id,title from article where createTime &gt; (select createTime from article where id = #{id}) ORDER BY createTime asc LIMIT 1
    </select>
    
    <update id="addArticleCount">
        update article set showCount = showCount+1 where id = #{id}
    </update>

</mapper>
